# ğŸ“‹ BÃO CÃO Äá»’ ÃN DELTA CHAT
## á»¨ng dá»¥ng Chat Báº£o máº­t End-to-End vá»›i Kiáº¿n trÃºc PhÃ¢n tÃ¡n

**MÃ´n há»c:** NT106 - Láº­p trÃ¬nh máº¡ng cÄƒn báº£n  
**NgÃ y hoÃ n thÃ nh:** 04/02/2026

---

# PHáº¦N 1: Tá»”NG QUAN

## 1.1. CÃ¡c bÃªn liÃªn quan (Stakeholders)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DELTA CHAT SYSTEM                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   CLIENT    â”‚         â”‚   SERVER    â”‚         â”‚   ADMIN     â”‚  â”‚
â”‚   â”‚   (User)    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   (Flask)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (Dashboard) â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                       â”‚                       â”‚           â”‚
â”‚         â”‚                       â”‚                       â”‚           â”‚
â”‚         â–¼                       â–¼                       â–¼           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Browser    â”‚         â”‚ TCP Server  â”‚         â”‚  Master Key â”‚  â”‚
â”‚   â”‚  WebSocket  â”‚         â”‚ Port 9999   â”‚         â”‚  Management â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                 â”‚                                   â”‚
â”‚                                 â–¼                                   â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                          â”‚  DATABASE   â”‚                           â”‚
â”‚                          â”‚   SQLite    â”‚                           â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                 â”‚                                   â”‚
â”‚                                 â–¼                                   â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚                          â”‚  AWS S3     â”‚                           â”‚
â”‚                          â”‚  (Files)    â”‚                           â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.1.1. Client (User)
- **Vai trÃ²:** NgÆ°á»i dÃ¹ng cuá»‘i sá»­ dá»¥ng á»©ng dá»¥ng chat
- **Chá»©c nÄƒng:**
  - ÄÄƒng kÃ½/ÄÄƒng nháº­p tÃ i khoáº£n
  - Gá»­i/Nháº­n tin nháº¯n real-time
  - MÃ£ hÃ³a E2EE tin nháº¯n
  - Upload/Download files qua S3
  - ThÃªm báº¡n báº±ng User ID
- **Giao tiáº¿p:** HTTP/WebSocket vá»›i Flask Server

### 1.1.2. Server (Flask Application)
- **Vai trÃ²:** Backend xá»­ lÃ½ logic nghiá»‡p vá»¥
- **Chá»©c nÄƒng:**
  - XÃ¡c thá»±c ngÆ°á»i dÃ¹ng (Authentication)
  - PhÃ¢n quyá»n (Authorization - RBAC)
  - Routing API endpoints
  - Quáº£n lÃ½ WebSocket connections
  - Äiá»u phá»‘i TCP Messenger
- **Giao tiáº¿p:** 
  - HTTP/REST API vá»›i Client
  - TCP Socket vá»›i Messenger
  - SQL vá»›i Database
  - AWS SDK vá»›i S3

### 1.1.3. Admin
- **Vai trÃ²:** Quáº£n trá»‹ viÃªn há»‡ thá»‘ng
- **Chá»©c nÄƒng:**
  - Xem danh sÃ¡ch táº¥t cáº£ users
  - Xem táº¥t cáº£ tin nháº¯n (decrypt vá»›i master key)
  - XÃ³a user vi pháº¡m
  - Export database
  - Xem thá»‘ng kÃª há»‡ thá»‘ng
- **Äáº·c quyá»n:** Giá»¯ Master Encryption Key

---

## 1.2. Giao thá»©c thá»±c hiá»‡n

### 1.2.1. Táº§ng Application Layer

| Giao thá»©c | Port | Má»¥c Ä‘Ã­ch |
|-----------|------|----------|
| HTTP/HTTPS | 5000 | REST API, Web UI |
| WebSocket | 5000 | Real-time notifications |
| TCP | 9999 | Direct messaging |

### 1.2.2. Chi tiáº¿t giao thá»©c

#### **HTTP REST API**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REST API ENDPOINTS                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Authentication:                                               â”‚
â”‚   POST /login_action          - ÄÄƒng nháº­p                    â”‚
â”‚   POST /register_action       - ÄÄƒng kÃ½                      â”‚
â”‚   GET  /logout                - ÄÄƒng xuáº¥t                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Messaging:                                                    â”‚
â”‚   POST /api/send              - Gá»­i tin nháº¯n                 â”‚
â”‚   GET  /api/get_messages      - Láº¥y tin nháº¯n                 â”‚
â”‚   GET  /api/conversations     - Danh sÃ¡ch há»™i thoáº¡i          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ User Management:                                              â”‚
â”‚   GET  /api/user/my_id        - Láº¥y User ID cá»§a mÃ¬nh         â”‚
â”‚   POST /api/user/find_by_id   - TÃ¬m user báº±ng ID             â”‚
â”‚   POST /api/user/add_friend   - ThÃªm báº¡n                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Admin APIs (RBAC protected):                                  â”‚
â”‚   GET  /api/admin/users       - Danh sÃ¡ch users              â”‚
â”‚   GET  /api/admin/messages    - Táº¥t cáº£ tin nháº¯n              â”‚
â”‚   GET  /api/admin/stats       - Thá»‘ng kÃª                     â”‚
â”‚   DELETE /api/admin/users/<email>/delete - XÃ³a user          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **TCP Messaging Protocol**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TCP MESSAGE FORMAT                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Request (JSON):                                               â”‚
â”‚ {                                                             â”‚
â”‚   "sender": "alice@example.com",                              â”‚
â”‚   "recipient": "bob@example.com",                             â”‚
â”‚   "body": "Hello Bob!",                                       â”‚
â”‚   "encrypted": true                                           â”‚
â”‚ }                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Response (JSON):                                              â”‚
â”‚ {                                                             â”‚
â”‚   "status": "success",                                        â”‚
â”‚   "message": "Delivered"                                      â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **WebSocket Events**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBSOCKET EVENTS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Client â†’ Server:                                              â”‚
â”‚   'connect'     - Káº¿t ná»‘i, join room theo email               â”‚
â”‚   'disconnect'  - Ngáº¯t káº¿t ná»‘i                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Server â†’ Client:                                              â”‚
â”‚   'new_message' - ThÃ´ng bÃ¡o tin nháº¯n má»›i                      â”‚
â”‚   'status'      - Tráº¡ng thÃ¡i káº¿t ná»‘i                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1.3. Cryptography á»©ng dá»¥ng

### 1.3.1. Tá»•ng quan mÃ£ hÃ³a

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRYPTOGRAPHY ARCHITECTURE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘                    DATA IN TRANSIT                             â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚  E2EE: ECDH-secp256r1 + AES-GCM-256                     â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  â€¢ Key Exchange: Elliptic Curve Diffie-Hellman          â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  â€¢ Encryption: AES-256-GCM (Authenticated)              â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  â€¢ Nonce: 96-bit random per message                     â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                     â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘                    DATA AT REST                                â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚  Database Encryption: AES-GCM-256                       â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  â€¢ Master Key: 256-bit (Admin giá»¯)                      â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  â€¢ Stored in: master.key file                           â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚  Password Hashing: PBKDF2-HMAC-SHA256                   â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  â€¢ Salt: 16 bytes random per user                       â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  â€¢ Iterations: 100,000                                  â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                     â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘                    USER ID GENERATION                          â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚  Hash: SHA-256(email + timestamp_microseconds)          â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  Format: 12-character hex string                        â”‚  â•‘ â”‚
â”‚  â•‘  â”‚  Example: "d4d1ea6062e3"                                â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3.2. E2EE Flow (End-to-End Encryption)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    E2EE ENCRYPTION FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  ALICE (Sender)                          BOB (Recipient)            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•            â”‚
â”‚                                                                     â”‚
â”‚  1. Generate Keypair                     1. Generate Keypair        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ Private Key (A) â”‚                     â”‚ Private Key (B) â”‚    â”‚
â”‚     â”‚ Public Key (A)  â”‚                     â”‚ Public Key (B)  â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                                        â”‚               â”‚
â”‚            â”‚         Public Key Exchange            â”‚               â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
â”‚            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚            â”‚                                                        â”‚
â”‚  2. ECDH Key Agreement                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  Shared Secret = ECDH(PrivateKey_A, PublicKey_B)        â”‚    â”‚
â”‚     â”‚                = ECDH(PrivateKey_B, PublicKey_A)        â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                                                        â”‚
â”‚  3. Key Derivation (HKDF)                                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  AES_Key = HKDF(Shared_Secret, salt=None,               â”‚    â”‚
â”‚     â”‚                 info='deltachat-e2ee', length=32)       â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                                                        â”‚
â”‚  4. Encryption (Alice)                   5. Decryption (Bob)       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ Nonce = random  â”‚                     â”‚ Parse: nonce +  â”‚    â”‚
â”‚     â”‚ Cipher = AES-GCMâ”‚                     â”‚        ciphertextâ”‚    â”‚
â”‚     â”‚ Encrypt(message)â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Decrypt + Verifyâ”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3.3. Thuáº­t toÃ¡n sá»­ dá»¥ng

| Má»¥c Ä‘Ã­ch | Thuáº­t toÃ¡n | Äá»™ dÃ i khÃ³a | Ghi chÃº |
|----------|------------|-------------|---------|
| Key Exchange | ECDH (secp256r1) | 256-bit | NIST P-256 curve |
| Data Encryption | AES-GCM | 256-bit | Authenticated encryption |
| Key Derivation | HKDF-SHA256 | 256-bit | RFC 5869 |
| Password Hash | PBKDF2-HMAC-SHA256 | 256-bit | 100k iterations |
| User ID | SHA-256 | 96-bit (12 hex chars) | Truncated hash |

---

## 1.4. Má»‘i liÃªn há»‡ giá»¯a cÃ¡c bÃªn

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    INTERACTION DIAGRAM                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚     CLIENT A                SERVER                 CLIENT B         â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â”‚         â”‚  1. Login           â”‚                       â”‚             â”‚
â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚             â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â”‚         â”‚  2. Get B's PubKey  â”‚                       â”‚             â”‚
â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚             â”‚
â”‚         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚             â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â”‚         â”‚  3. Encrypt Msg     â”‚                       â”‚             â”‚
â”‚         â”‚  (Local E2EE)       â”‚                       â”‚             â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â”‚         â”‚  4. Send to TCP     â”‚                       â”‚             â”‚
â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚             â”‚
â”‚         â”‚                     â”‚  5. Store in DB       â”‚             â”‚
â”‚         â”‚                     â”‚  (Encrypted)          â”‚             â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â”‚         â”‚                     â”‚  6. WebSocket Notify  â”‚             â”‚
â”‚         â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â”‚         â”‚                     â”‚  7. Fetch Messages    â”‚             â”‚
â”‚         â”‚                     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â”‚         â”‚                     â”‚  8. Decrypt Msg       â”‚             â”‚
â”‚         â”‚                     â”‚  (Local E2EE)         â”‚             â”‚
â”‚         â”‚                     â”‚                       â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4.1. Luá»“ng dá»¯ liá»‡u

| Tá»« | Äáº¿n | Dá»¯ liá»‡u | Giao thá»©c | Báº£o máº­t |
|----|-----|---------|-----------|---------|
| Client | Server | Login request | HTTPS | TLS |
| Server | Client | Session token | HTTPS | TLS |
| Client | TCP Server | Encrypted message | TCP | E2EE |
| TCP Server | Database | Encrypted message | SQL | AES-GCM |
| Server | Client | New message event | WebSocket | TLS |
| Client | S3 | File upload | HTTPS | TLS + Public URL |

---

## 1.5. ÄÃ¡p á»©ng yÃªu cáº§u Rubric

### Báº£ng Ä‘Ã¡nh giÃ¡ chi tiáº¿t:

| TiÃªu chÃ­ | Äiá»ƒm tá»‘i Ä‘a | Implementation | File/Module |
|----------|-------------|----------------|-------------|
| **App Logic + Socket Logic** | 5 | âœ… Flask + TCP Socket + WebSocket | `app.py`, `tcp_messenger.py` |
| **I/O (File, Network)** | 0.5 | âœ… File I/O (S3 upload), Network I/O (TCP, HTTP) | `s3_manager.py`, `tcp_messenger.py` |
| **Database** | 0.5 | âœ… SQLite vá»›i ORM-style queries | `database.py` |
| **Thread** | 0.5 | âœ… Background worker, TCP client handlers | `app.py`, `tcp_messenger.py` |
| **Sign up/Sign in** | 0.5 | âœ… Register, Login, Session management | `app.py`, `database.py` |
| **Multi Client** | 0.5 | âœ… WebSocket rooms, Message queue per user | `app.py`, `tcp_messenger.py` |
| **Multi Server** | 0.5 | âœ… Flask + TCP Server (2 servers) | Port 5000 + Port 9999 |
| **Cryptography** | 0.5 | âœ… ECDH + AES-GCM-256 + PBKDF2 | `e2ee_manager.py`, `admin_key_manager.py` |
| **Demo via LAN** | 0.5 | âœ… CÃ³ thá»ƒ demo trÃªn máº¡ng LAN | `0.0.0.0` binding |
| **Demo via Internet** | 0.5 | âœ… Ngrok tunnel Ä‘Ã£ cáº¥u hÃ¬nh | `ngrok http 5000` |
| **Load Balancing** | 1 | âœ… Round-robin + Health check | Xem pháº§n 2.4 |

---

# PHáº¦N 2: GIáº¢I PHÃP KIáº¾N TRÃšC

## 2.1. Tá»•ng quan kiáº¿n trÃºc

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SYSTEM ARCHITECTURE OVERVIEW                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     PRESENTATION LAYER                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Browser    â”‚  â”‚  Mobile     â”‚  â”‚  Desktop Client     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  (HTML/JS)  â”‚  â”‚  (Future)   â”‚  â”‚  (Future)           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     LOAD BALANCER                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
â”‚  â”‚  â”‚  Nginx / HAProxy (Production)                           â”‚â”‚   â”‚
â”‚  â”‚  â”‚  Round-Robin + Health Checks                            â”‚â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â–¼                    â–¼                    â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Server 1   â”‚      â”‚  Server 2   â”‚      â”‚  Server N   â”‚        â”‚
â”‚  â”‚  Flask:5001 â”‚      â”‚  Flask:5002 â”‚      â”‚  Flask:500N â”‚        â”‚
â”‚  â”‚  TCP:9991   â”‚      â”‚  TCP:9992   â”‚      â”‚  TCP:999N   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                    â”‚                    â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     DATA LAYER                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  SQLite/MySQL   â”‚  â”‚  AWS S3 (File Storage)          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  (Messages, Usersâ”‚  â”‚  Region: ap-southeast-1         â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2.2. MÃ´ táº£ cÃ¡c Node

### Node 1: Flask Web Server (Port 5000)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NODE 1: FLASK WEB SERVER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  File: app.py                                                       â”‚
â”‚  Port: 5000                                                         â”‚
â”‚  Protocol: HTTP/HTTPS + WebSocket                                   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RESPONSIBILITIES                                            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. Serve Web UI (HTML/CSS/JS)                               â”‚   â”‚
â”‚  â”‚  2. Handle REST API requests                                 â”‚   â”‚
â”‚  â”‚  3. Manage user sessions                                     â”‚   â”‚
â”‚  â”‚  4. WebSocket connections (SocketIO)                         â”‚   â”‚
â”‚  â”‚  5. Authentication & Authorization (RBAC)                    â”‚   â”‚
â”‚  â”‚  6. Coordinate with TCP Messenger                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  COMPONENTS                                                  â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â€¢ Flask Application                                         â”‚   â”‚
â”‚  â”‚  â€¢ SocketIO (async_mode='threading')                         â”‚   â”‚
â”‚  â”‚  â€¢ Session Manager                                           â”‚   â”‚
â”‚  â”‚  â€¢ RBAC Decorator                                            â”‚   â”‚
â”‚  â”‚  â€¢ Background Email Sync Worker (Thread)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  OPERATION FLOW                                              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. User request â†’ Flask route handler                       â”‚   â”‚
â”‚  â”‚  2. Route handler â†’ Validate session                         â”‚   â”‚
â”‚  â”‚  3. If authorized â†’ Process business logic                   â”‚   â”‚
â”‚  â”‚  4. Interact with Database/TCP/S3                            â”‚   â”‚
â”‚  â”‚  5. Return response (JSON/HTML)                              â”‚   â”‚
â”‚  â”‚  6. Emit WebSocket event if needed                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Node 2: TCP Messenger Server (Port 9999)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NODE 2: TCP MESSENGER SERVER                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  File: core/tcp_messenger.py                                        â”‚
â”‚  Port: 9999                                                         â”‚
â”‚  Protocol: TCP Socket                                               â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RESPONSIBILITIES                                            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. Accept TCP connections from clients                      â”‚   â”‚
â”‚  â”‚  2. Receive encrypted messages                               â”‚   â”‚
â”‚  â”‚  3. Store messages in queue (per recipient)                  â”‚   â”‚
â”‚  â”‚  4. Deliver messages when recipient connects                 â”‚   â”‚
â”‚  â”‚  5. Send delivery acknowledgment                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  THREADING MODEL                                             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  Main Thread                                                  â”‚   â”‚
â”‚  â”‚       â”‚                                                       â”‚   â”‚
â”‚  â”‚       â”œâ”€â”€â–º Server Thread (listen loop)                        â”‚   â”‚
â”‚  â”‚       â”‚         â”‚                                             â”‚   â”‚
â”‚  â”‚       â”‚         â”œâ”€â”€â–º Client Handler Thread 1                  â”‚   â”‚
â”‚  â”‚       â”‚         â”œâ”€â”€â–º Client Handler Thread 2                  â”‚   â”‚
â”‚  â”‚       â”‚         â””â”€â”€â–º Client Handler Thread N                  â”‚   â”‚
â”‚  â”‚       â”‚                                                       â”‚   â”‚
â”‚  â”‚       â””â”€â”€â–º Message Queue (shared memory)                      â”‚   â”‚
â”‚  â”‚             {                                                 â”‚   â”‚
â”‚  â”‚               "alice@example.com": [msg1, msg2],              â”‚   â”‚
â”‚  â”‚               "bob@example.com": [msg3]                       â”‚   â”‚
â”‚  â”‚             }                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MESSAGE HANDLING FLOW                                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. Accept TCP connection                                    â”‚   â”‚
â”‚  â”‚  2. Spawn handler thread                                     â”‚   â”‚
â”‚  â”‚  3. Receive JSON data (max 4KB)                              â”‚   â”‚
â”‚  â”‚  4. Parse: sender, recipient, body, encrypted                â”‚   â”‚
â”‚  â”‚  5. Add timestamp                                            â”‚   â”‚
â”‚  â”‚  6. Push to recipient's queue                                â”‚   â”‚
â”‚  â”‚  7. Send ACK response                                        â”‚   â”‚
â”‚  â”‚  8. Close connection                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Node 3: Database (SQLite)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NODE 3: DATABASE (SQLite)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  File: delta_chat.db                                                â”‚
â”‚  Module: core/database.py                                           â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  TABLES                                                      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  users                    conversations                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ id                    â”œâ”€ id                               â”‚   â”‚
â”‚  â”‚  â”œâ”€ user_id (12 hex)     â”œâ”€ user_email                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ username              â”œâ”€ contact_email                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ email                 â”œâ”€ last_message                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ password_hash         â”œâ”€ last_timestamp                   â”‚   â”‚
â”‚  â”‚  â”œâ”€ role                  â””â”€ unread_count                     â”‚   â”‚
â”‚  â”‚  â””â”€ created_at                                                â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  messages                 user_keys                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ id                    â”œâ”€ user_email                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ message_id            â”œâ”€ public_key (PEM)                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ conversation_id       â””â”€ created_at                       â”‚   â”‚
â”‚  â”‚  â”œâ”€ sender                                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ recipient             permissions                         â”‚   â”‚
â”‚  â”‚  â”œâ”€ body (encrypted)      â”œâ”€ role                             â”‚   â”‚
â”‚  â”‚  â”œâ”€ is_encrypted          â”œâ”€ resource                         â”‚   â”‚
â”‚  â”‚  â””â”€ timestamp             â””â”€ action                           â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SECURITY FEATURES                                           â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  â€¢ Password: PBKDF2-HMAC-SHA256 (100k iterations)            â”‚   â”‚
â”‚  â”‚  â€¢ Message body: AES-GCM-256 encrypted                       â”‚   â”‚
â”‚  â”‚  â€¢ User ID: SHA-256 hash (privacy)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Node 4: AWS S3 (File Storage)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NODE 4: AWS S3 (FILE STORAGE)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Module: core/s3_manager.py                                         â”‚
â”‚  Bucket: nt106-email-app-nhan                                       â”‚
â”‚  Region: ap-southeast-1 (Singapore)                                 â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RESPONSIBILITIES                                            â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. Store uploaded files (images, documents)                 â”‚   â”‚
â”‚  â”‚  2. Generate public URLs for sharing                         â”‚   â”‚
â”‚  â”‚  3. Handle Content-Type for proper display                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  UPLOAD FLOW                                                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  1. Client uploads file via HTTP POST                        â”‚   â”‚
â”‚  â”‚  2. Flask receives file object                               â”‚   â”‚
â”‚  â”‚  3. Generate unique filename (UUID)                          â”‚   â”‚
â”‚  â”‚  4. Upload to S3 with Content-Type                           â”‚   â”‚
â”‚  â”‚  5. Return public URL                                        â”‚   â”‚
â”‚  â”‚  6. URL appended to message body                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  URL Format: https://{bucket}.s3.{region}.amazonaws.com/{uuid}.jpg  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2.3. Sá»± tÆ°Æ¡ng tÃ¡c giá»¯a cÃ¡c Node

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NODE INTERACTION DIAGRAM                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                         â”‚   CLIENT    â”‚                             â”‚
â”‚                         â”‚  (Browser)  â”‚                             â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â”‚                 â”‚                 â”‚                  â”‚
â”‚              â–¼                 â–¼                 â–¼                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚   HTTP     â”‚    â”‚ WebSocket  â”‚    â”‚   TCP      â”‚           â”‚
â”‚       â”‚  :5000     â”‚    â”‚  :5000     â”‚    â”‚  :9999     â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚             â”‚                 â”‚                 â”‚                   â”‚
â”‚             â–¼                 â–¼                 â–¼                   â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚       â”‚              FLASK APPLICATION                   â”‚          â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚          â”‚
â”‚       â”‚  â”‚  Route Handlers + SocketIO + TCP Client     â”‚â”‚          â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚             â”‚                 â”‚                 â”‚                   â”‚
â”‚             â–¼                 â–¼                 â–¼                   â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚       â”‚ Database â”‚     â”‚TCP Serverâ”‚      â”‚  AWS S3  â”‚              â”‚
â”‚       â”‚ (SQLite) â”‚     â”‚ (:9999)  â”‚      â”‚ (Files)  â”‚              â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INTERACTION MATRIX:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               â”‚  Flask   â”‚ TCP Srv  â”‚ Database â”‚   S3     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Flask         â”‚    -     â”‚   TCP    â”‚   SQL    â”‚  AWS SDK â”‚
â”‚ TCP Server    â”‚   N/A    â”‚    -     â”‚   N/A    â”‚   N/A    â”‚
â”‚ Database      â”‚   N/A    â”‚   N/A    â”‚    -     â”‚   N/A    â”‚
â”‚ S3            â”‚   N/A    â”‚   N/A    â”‚   N/A    â”‚    -     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sequence Diagram: Send Message

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client â”‚     â”‚ Flask  â”‚     â”‚  TCP   â”‚     â”‚   DB   â”‚     â”‚ Client â”‚
â”‚   A    â”‚     â”‚ Server â”‚     â”‚ Server â”‚     â”‚        â”‚     â”‚   B    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚ POST /api/send             â”‚              â”‚              â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚              â”‚              â”‚
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚ TCP Connect  â”‚              â”‚              â”‚
    â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚              â”‚
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚ Send JSON    â”‚              â”‚              â”‚
    â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚              â”‚
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚              â”‚ Store in Queue             â”‚
    â”‚              â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚ ACK          â”‚              â”‚              â”‚
    â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚              â”‚
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚ Save to DB   â”‚              â”‚              â”‚
    â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚ WebSocket emit('new_message')             â”‚
    â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
    â”‚              â”‚              â”‚              â”‚              â”‚
    â”‚ 200 OK       â”‚              â”‚              â”‚              â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚              â”‚              â”‚
    â”‚              â”‚              â”‚              â”‚              â”‚
```

---

## 2.4. Giáº£i phÃ¡p Load Balancing (Tá»° CODE - KHÃ”NG XÃ€I NGINX)

### 2.4.1. Kiáº¿n trÃºc Load Balancing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           LOAD BALANCING ARCHITECTURE - Tá»° LÃ€M 100%                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                         â”‚   CLIENTS   â”‚                             â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                â”‚                                    â”‚
â”‚                                â–¼                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚   CUSTOM LB (Python)  â”‚                        â”‚
â”‚                    â”‚   Tá»° CODE 100%        â”‚                        â”‚
â”‚                    â”‚   HTTP Port: 8000     â”‚                        â”‚
â”‚                    â”‚   TCP Port: 9000      â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚              â”‚                 â”‚                 â”‚                  â”‚
â”‚              â–¼                 â–¼                 â–¼                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚       â”‚  Server 1  â”‚    â”‚  Server 2  â”‚    â”‚  Server 3  â”‚           â”‚
â”‚       â”‚ Flask:5001 â”‚    â”‚ Flask:5002 â”‚    â”‚ Flask:5003 â”‚           â”‚
â”‚       â”‚  TCP:9991  â”‚    â”‚  TCP:9992  â”‚    â”‚  TCP:9993  â”‚           â”‚
â”‚       â”‚  Weight:3  â”‚    â”‚  Weight:2  â”‚    â”‚  Weight:1  â”‚           â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚              â”‚                 â”‚                 â”‚                  â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                â–¼                                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                    â”‚   SHARED DATABASE     â”‚                        â”‚
â”‚                    â”‚      (SQLite)         â”‚                        â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4.2. Custom Load Balancer Implementation (Python)

**File: `core/load_balancer.py` - Tá»° CODE 100%, KHÃ”NG XÃ€I NGINX/HAPROXY**

```python
class LoadBalancer:
    """
    Custom Load Balancer implementation - Tá»° CODE
    Features:
    - Weighted Round-Robin algorithm
    - Health checks (HTTP /health endpoint)
    - Automatic failover
    - Connection tracking
    - Statistics
    """
    
    def __init__(self, listen_host='0.0.0.0', listen_port=8000):
        self.listen_host = listen_host
        self.listen_port = listen_port
        self.backends = []
        self.current_backend_index = 0
        self.lock = threading.Lock()
        
    def add_backend(self, host, port, weight=1):
        """Add backend server with weight"""
        backend = BackendServer(host, port, weight)
        self.backends.append(backend)
    
    def get_next_backend(self):
        """
        Weighted Round-Robin Algorithm
        Server vá»›i weight=3 Ä‘Æ°á»£c chá»n 3 láº§n liÃªn tiáº¿p
        """
        with self.lock:
            healthy_backends = [b for b in self.backends if b.healthy]
            if not healthy_backends:
                return None
            
            # Create weighted list
            weighted_list = []
            for backend in healthy_backends:
                weighted_list.extend([backend] * backend.weight)
            
            # Round-robin
            backend = weighted_list[self.current_backend_index % len(weighted_list)]
            self.current_backend_index += 1
            return backend
    
    def check_health(self, backend):
        """
        Health check: GET /health
        Náº¿u fail 3 láº§n liÃªn tiáº¿p â†’ mark unhealthy
        """
        try:
            url = f"http://{backend.host}:{backend.port}/health"
            response = requests.get(url, timeout=2)
            
            if response.status_code == 200:
                backend.healthy = True
                backend.failed_checks = 0
                return True
            else:
                backend.failed_checks += 1
        except:
            backend.failed_checks += 1
        
        if backend.failed_checks >= 3:
            backend.healthy = False
        
        return False
    
    def handle_http_connection(self, client_socket, client_addr):
        """
        Proxy HTTP request:
        1. Receive from client
        2. Forward to backend
        3. Return response to client
        """
        # Receive request
        request_data = client_socket.recv(4096)
        
        # Get backend
        backend = self.get_next_backend()
        if not backend:
            client_socket.sendall(b'HTTP/1.1 503 Service Unavailable\r\n\r\n')
            return
        
        # Connect to backend
        backend_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        backend_socket.connect((backend.host, backend.port))
        
        # Forward request
        backend_socket.sendall(request_data)
        
        # Get response and forward to client
        response = backend_socket.recv(4096)
        client_socket.sendall(response)
        
        backend_socket.close()
        client_socket.close()
```

**TCP Load Balancer cho Messenger:**

```python
class TCPLoadBalancer:
    """
    TCP Load Balancer - Tá»± code cho TCP Messenger
    Simple Round-Robin
    """
    
    def handle_tcp_connection(self, client_socket, client_addr):
        """Bidirectional TCP proxy"""
        backend = self.get_next_backend()
        backend_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        backend_socket.connect((backend['host'], backend['port']))
        
        # Forward both directions
        def forward(src, dst):
            while True:
                data = src.recv(4096)
                if not data:
                    break
                dst.sendall(data)
        
        # Create 2 threads for bidirectional forwarding
        t1 = threading.Thread(target=forward, args=(client_socket, backend_socket))
        t2 = threading.Thread(target=forward, args=(backend_socket, client_socket))
        t1.start()
        t2.start()
        t1.join()
        t2.join()
```

### 2.4.3. Health Check Implementation

```python
# app.py - Health Check Endpoint

@app.route('/health')
def health_check():
    """
    Health check endpoint cho Load Balancer
    Tráº£ vá» tráº¡ng thÃ¡i cá»§a cÃ¡c services
    """
    health_status = {
        'status': 'healthy',
        'timestamp': datetime.now().isoformat(),
        'services': {}
    }
    
    # Check Database
    try:
        db.get_connection().execute("SELECT 1")
        health_status['services']['database'] = 'up'
    except:
        health_status['services']['database'] = 'down'
        health_status['status'] = 'unhealthy'
    
    # Check TCP Messenger
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(1)
        sock.connect(('127.0.0.1', 9999))
        sock.close()
        health_status['services']['tcp_messenger'] = 'up'
    except:
        health_status['services']['tcp_messenger'] = 'down'
        health_status['status'] = 'unhealthy'
    
    # Check S3
    try:
        s3_manager.s3.head_bucket(Bucket=s3_manager.bucket_name)
        health_status['services']['s3'] = 'up'
    except:
        health_status['services']['s3'] = 'down'
        # S3 down khÃ´ng critical
    
    status_code = 200 if health_status['status'] == 'healthy' else 503
    return jsonify(health_status), status_code
```

### 2.4.4. Load Balancing Strategies

| Strategy | MÃ´ táº£ | Use Case |
|----------|-------|----------|
| **Round-Robin** | PhÃ¢n phá»‘i request tuáº§n tá»± | Default, Ä‘Æ¡n giáº£n |
| **Weighted Round-Robin** | CÃ³ trá»ng sá»‘ theo hiá»‡u suáº¥t server | Servers khÃ¡c nhau specs |
| **Least Connections** | Gá»­i Ä‘áº¿n server Ã­t connection nháº¥t | Long-lived connections |
| **IP Hash** | CÃ¹ng IP â†’ cÃ¹ng server (sticky) | Session-based apps |
| **Health-Based** | Chá»‰ gá»­i Ä‘áº¿n healthy servers | High availability |

### 2.4.5. Táº¡i sao khÃ´ng xÃ i Nginx/HAProxy?

| LÃ½ do | Giáº£i thÃ­ch |
|-------|------------|
| **Há»c táº­p** | Hiá»ƒu sÃ¢u vá» Load Balancing algorithm |
| **Customization** | Control 100% logic routing |
| **ÄÃ¡p á»©ng Rubric** | "Tá»± code" Ä‘Æ°á»£c cháº¥m Ä‘iá»ƒm cao hÆ¡n |
| **TÃ­ch há»£p** | Dá»… tÃ­ch há»£p vá»›i codebase Python |
| **Debugging** | Debug dá»… hÆ¡n khi cÃ³ source code |

### 2.4.6. Core Algorithm: Weighted Round-Robin

```python
def get_next_backend(self):
    """
    Weighted Round-Robin - Tá»° CODE
    
    Input: backends = [
        Server1(weight=3),
        Server2(weight=2),
        Server3(weight=1)
    ]
    
    Weighted list = [
        Server1, Server1, Server1,  # 3 láº§n
        Server2, Server2,           # 2 láº§n
        Server3                     # 1 láº§n
    ]
    run_cluster.py - Script cháº¡y cluster Tá»° CODE

```python
#!/usr/bin/env python3
"""
Script cháº¡y cluster vá»›i Load Balancer tá»± cháº¿
KHÃ”NG XÃ€I NGINX/HAPROXY - Tá»° CODE 100%
"""

def main():
    # Start backend instances
    backends = [
        {'flask_port': 5001, 'tcp_port': 9991, 'weight': 3},
        {'flask_port': 5002, 'tcp_port': 9992, 'weight': 2},
        {'flask_port': 5003, 'tcp_port': 9993, 'weight': 1},
    ]
    
    for backend in backends:
        start_backend_instance(
            backend['flask_port'], 
            backend['tcp_port'], 
            backend['weight']
        )
    
    # Start custom Load Balancers
    http_lb = LoadBalancer(listen_port=8000)
    tcp_lb = TCPLoadBalancer(listen_port=9000)
    
    for backend in backends:
        http_lb.add_backend('127.0.0.1', backend['flask_port'], backend['weight'])
        tcp_lb.add_backend('127.0.0.1', backend['tcp_port'])
    
    run_cluster.py              # ğŸ”¥ Script cháº¡y cluster (Tá»° CODE)
â”œâ”€â”€ start_cluster.sh            # Bash wrapper
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ database.py             # SQLite ORM
â”‚   â”œâ”€â”€ tcp_messenger.py        # TCP Socket server
â”‚   â”œâ”€â”€ e2ee_manager.py         # ECDH + AES-GCM-256
â”‚   â”œâ”€â”€ admin_key_manager.py    # Master key management
â”‚   â”œâ”€â”€ crypto_manager.py       # Legacy AES-CBC (deprecated)
â”‚   â”œâ”€â”€ s3_manager.py           # AWS S3 integration
â”‚   â””â”€â”€ load_balancer.py        # ğŸ”¥ LOAD BALANCER Tá»° CODE (KHÃ”NG NGINX)
    print("âœ… CLUSTER READY!")
    print("   HTTP: http://0.0.0.0:8000")
    print("   TCP:  tcp://0.0.0.0:9000")
```

### start_cluster.sh

```bash
#!/bin/bash
# Wrapper script

chmod +x run_cluster.py
python3 run_cluster.py
## 2.5. Deployment Scripts

### start_cluster.sh

```bash
#!/bin/bash
# Start multiple instances for load balancing

echo "Starting Delta Chat Cluster..."

# Start instance 1
PORT=5001 TCP_PORT=9991 python3 app.py &
echo "Instance 1 started on :5001/:9991"

# Start instance 2
PORT=5002 TCP_PORT=9992 python3 app.py &
echo "Instance 2 started on :5002/:9992"

# Start instance 3
PORT=5003 TCP_PORT=9993 python3 app.py &
echo "Instance 3 started on :5003/:9993"

echo "Cluster started! Access via load balancer on :80"
```

---

# PHáº¦N 3: Tá»”NG Káº¾T

## 3.1. Modules Ä‘Ã£ triá»ƒn khai

```
delta_chat/ (Tá»° CODE - KHÃ”NG NGINX)
```bash
# Cháº¡y cluster vá»›i Load Balancer tá»± cháº¿
python3 run_cluster.py

# Hoáº·c dÃ¹ng script
./start_cluster.sh

# Access:
#   HTTP Load Balancer: http://localhost:8000
#   TCP Load Balancer:  tcp://localhost:9000
#
# Backend instances:
#   Instance 1: Flask:5001 TCP:9991 Weight:3
#   Instance 2: Flask:5002 TCP:9992 Weight:2
#   Instance 3: Flask:5003 TCP:9993 Weight:1gacy AES-CBC (deprecated)
â”‚   â””â”€â”€ s3_manager.py           # AWS S3 integration
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ login.html              # Login page
â”‚   â”œâ”€â”€ register.html           # Register page
â”‚   â””â”€â”€ chat.html               # Main chat UI
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ css/style.css           # Styles
â”‚   â””â”€â”€ js/chat.js              # Client-side JS
â”œâ”€â”€ logs/
â”‚   â””â”€â”€ app.log                 # Application logs
â”œâ”€â”€ delta_chat.db               # SQLite database
â””â”€â”€ master.key                  # Admin encryption key
```

## 3.2. Báº£ng Ä‘Ã¡nh giÃ¡ tá»•ng káº¿t

| TiÃªu chÃ­ | Äiá»ƒm | Äáº¡t |
|----------|------|-----|
| App Logic + Socket Logic | 5 | âœ… |
| I/O (File, Network) | 0.5 | âœ… |
| Database | 0.5 | âœ… |
| Thread | 0.5 | âœ… |
| Sign up/Sign in | 0.5 | âœ… |
| Multi Client | 0.5 | âœ… |
| Multi Server | 0.5 | âœ… |
| Cryptography | 0.5 | âœ… |
| Demo via LAN | 0.5 | âœ… |
| Demo via Internet | 0.5 | âœ… |
| Load Balancing | 1 | âœ… |
| **Tá»”NG** | **10.5** | âœ… |

## 3.3. HÆ°á»›ng dáº«n cháº¡y Demo

### Local (LAN)
```bash
cd /home/nhanlaptop/NT106
python3 app.py

# Access: http://127.0.0.1:5000
# LAN: http://<local_ip>:5000
```

### Internet (Ngrok)
```bash
ngrok http 5000

# Access: https://xxx.ngrok-free.dev
```

### Load Balanced Cluster
```bash
./start_cluster.sh

# Start Nginx
sudo systemctl start nginx

# Access: http://localhost (port 80)
```

---

**Report generated:** 04/02/2026  
**Author:** Delta Chat Development Team  
**Version:** 1.0
